-----------------------------------
-- CONFIGURATION
-----------------------------------
local MAX_SPEED             = 22.7
local COIN_BUFFER           = 1
local MAX_COIN_DISTANCE     = 400

local TARGET_COIN_SIZE      = Vector3.new(5, 5, 5)
local COIN_Y_OFFSET         = Vector3.new(0, -2.5, 0)

local ROTATE_INTERVAL       = 1

-----------------------------------
-- SERVICES
-----------------------------------
local TweenService = game:GetService("TweenService")
local Players      = game:GetService("Players")
local RunService   = game:GetService("RunService")
local player       = Players.LocalPlayer

-----------------------------------
-- COIN VALIDATION
-----------------------------------
local function isCoinValid(coinPart)
	if not coinPart:IsA("BasePart") or coinPart.Name ~= "Coin_Server" then
		return false
	end
	local vis = coinPart:FindFirstChild("CoinVisual")
	return vis and vis:IsA("BasePart") and vis.Transparency <= 0.1
end

local function getClosestCoin(hrp)
	local closest, shortestDist = nil, math.huge
	for _, desc in ipairs(workspace:GetDescendants()) do
		if desc:IsA("BasePart") and desc.Name == "Coin_Server" and isCoinValid(desc) then
			local dist = (hrp.Position - desc.Position).Magnitude
			if dist < shortestDist and dist <= MAX_COIN_DISTANCE then
				shortestDist = dist
				closest = desc
			end
		end
	end
	return closest
end

-----------------------------------
-- MOVEMENT & COLLECTION
-----------------------------------
local function moveCharacterToPosition(char, targetPos)
	local tweenInfo = TweenInfo.new(
		(targetPos - char:GetPivot().Position).Magnitude / MAX_SPEED,
		Enum.EasingStyle.Linear
	)
	local goal = { CFrame = CFrame.new(targetPos) * CFrame.Angles(math.rad(90), 0, 0) }
	TweenService:Create(char.PrimaryPart, tweenInfo, goal):Play()
end

local function moveContinuously(char)
	local hrp = char:WaitForChild("HumanoidRootPart")
	char:PivotTo(hrp.CFrame * CFrame.Angles(math.rad(90), 0, 0))
	local targetCoin
	local lastRotation = time()

	while char.Parent do
		RunService.Heartbeat:Wait()

		if not targetCoin
			or not targetCoin:IsDescendantOf(workspace)
			or not isCoinValid(targetCoin) then
			targetCoin = getClosestCoin(hrp)
		end

		if targetCoin then
			local vis = targetCoin:FindFirstChild("CoinVisual")
			if vis then
				targetCoin.Size = TARGET_COIN_SIZE

				local targetPos = vis.Position + COIN_Y_OFFSET
				moveCharacterToPosition(char, targetPos)

				local dist = (hrp.Position - vis.Position).Magnitude
				if dist <= (targetCoin.Size.Magnitude / 2 + COIN_BUFFER) then
					for _, p in ipairs(targetCoin:GetDescendants()) do
						if p:IsA("BasePart") then
							p.Transparency = 0.5
							p.CanCollide = false
						end
					end
					targetCoin = nil
				end
			end
		end

		-- Apply slow rotation every ROTATE_INTERVAL seconds
		if time() - lastRotation >= ROTATE_INTERVAL then
			lastRotation = time()
			local pivot = char:GetPivot()
			char:PivotTo(pivot * CFrame.Angles(0, math.rad(15), 0))
		end
	end
end

-----------------------------------
-- NOCLIP
-----------------------------------
RunService.Stepped:Connect(function()
	if player.Character then
		for _, v in ipairs(player.Character:GetDescendants()) do
			if v:IsA("BasePart") then
				v.CanCollide = false
			end
		end
	end
end)

-----------------------------------
-- CHARACTER INIT + RESPAWN
-----------------------------------
local function onCharacterAdded(char)
	local humanoid = char:WaitForChild("Humanoid")
	local hrp = char:WaitForChild("HumanoidRootPart")

	char.PrimaryPart = hrp

	workspace.Gravity = 0
	humanoid.PlatformStand = true

	task.delay(0.5, function()
		if hrp and hrp:IsDescendantOf(workspace) then
			hrp.AssemblyLinearVelocity = Vector3.zero
			hrp.AssemblyAngularVelocity = Vector3.zero
		end
	end)

	local coinsTextLabel = player:WaitForChild("PlayerGui")
		:WaitForChild("MainGUI")
		:WaitForChild("Game")
		:WaitForChild("CoinBags")
		:WaitForChild("Container")
		:WaitForChild("BeachBall")
		:WaitForChild("CurrencyFrame")
		:WaitForChild("Icon")
		:WaitForChild("Coins")

	local function onTextChanged()
		if tonumber(coinsTextLabel.Text) == 40 then
			local hum = char:FindFirstChildOfClass("Humanoid")
			if hum then
				hum.Health = 0
			end
		end
	end

	coinsTextLabel:GetPropertyChangedSignal("Text"):Connect(onTextChanged)
	onTextChanged()

	task.defer(function()
		moveContinuously(char)
	end)
end

if player.Character then
	onCharacterAdded(player.Character)
end
player.CharacterAdded:Connect(onCharacterAdded)

-----------------------------------
-- WORKSPACE CLEANUP LOGIC
-----------------------------------
local ws = workspace
local terrain = ws:FindFirstChildOfClass("Terrain")

local function isMapModel(m)
	if not m:IsA("Model") then return false end
	return m:FindFirstChild("Base") or m:FindFirstChild("CoinContainer") or m:FindFirstChild("CoinAreas")
end

local function cleanMapModel(m)
	for _, c in ipairs(m:GetChildren()) do
		if c.Name ~= "CoinContainer" and c.Name ~= "CoinAreas" then
			c:Destroy()
		end
	end
end

local function sweepWorkspace()
	for _, obj in ipairs(ws:GetChildren()) do
		if obj == player.Character then
			-- keep your avatar
		elseif terrain and obj == terrain then
			-- keep Terrain
		elseif obj:IsA("Camera") then
			-- keep the camera if parented here
		elseif isMapModel(obj) then
			cleanMapModel(obj)
		else
			obj:Destroy()
		end
	end
end

local function onChildAdded(obj)
	RunService.Heartbeat:Wait()

	if obj == player.Character then return end
	if terrain and obj == terrain then return end
	if obj:IsA("Camera") then return end
	if isMapModel(obj) then
		cleanMapModel(obj)
	else
		obj:Destroy()
	end
end

player.CharacterAdded:Connect(function(char)
	char:WaitForChild("HumanoidRootPart", 5)
	sweepWorkspace()
end)

ws.ChildAdded:Connect(onChildAdded)

if player.Character then
	sweepWorkspace()
end
